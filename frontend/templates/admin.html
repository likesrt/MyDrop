<!doctype html>
<!-- moved to templates/admin.html -->
<html lang="zh" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="color-scheme" content="light dark" />
    <title>MyDrop 管理</title>
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    <link rel="manifest" href="/static/manifest.webmanifest" />
    <meta name="theme-color" content="#0ea5e9" />
    <link rel="stylesheet" href="/static/tailwind.css" />
    <!-- SweetAlert2: prefer local vendor, fallback to CDN -->
    <link rel="stylesheet" href="/static/vendor/sweetalert2.min.css" />
    <script src="/static/vendor/sweetalert2.all.min.js"></script>
    <link rel="stylesheet" href="/index.css" />
    <script src="/static/vendor/jsqr.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/sw.js').catch(function(){});
        });
      }
    </script>
  </head>
  <body class="bg-slate-100 min-h-[100dvh]">
    <div class="bg-decor" aria-hidden="true"></div>
    <header id="mainHeader" class="border-b backdrop-blur px-4 py-3 flex items-center justify-between sticky top-0 z-10 anim-fadeInDown">
      <div class="font-semibold flex items-center gap-2">
        <a href="/" class="hover:underline">MyDrop 设置</a>
      </div>
      <a id="backToChatBtn" href="/" class="btn pressable" aria-label="返回聊天">返回聊天</a>
    </header>
    <main class="max-w-5xl mx-auto p-4 anim-fadeIn" style="animation-delay:.4s">
      <div class="mb-3 flex items-center gap-2 flex-wrap">
        <button id="tabDashboardBtn" class="btn pressable" data-tab="dashboard">仪表盘</button>
        <button id="tabSettingsBtn" class="btn pressable" data-tab="settings">账号设置</button>
        <button id="tabDevicesBtn" class="btn pressable" data-tab="devices">设备管理</button>
        <button id="tabSystemBtn" class="btn pressable" data-tab="system">系统设置</button>
        <button id="tabMessagesBtn" class="btn pressable" data-tab="messages">消息管理</button>
        <button id="tabCacheBtn" class="btn pressable" data-tab="cache">缓存管理</button>
      </div>
      <div id="notice" class="hidden p-3 mb-3 rounded bg-amber-50 text-amber-800 text-sm"></div>

      <section id="tab-dashboard" class="bg-white rounded shadow p-4 hidden">
        <h2 class="font-medium mb-3">仪表盘</h2>
        <div id="dashboardCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3"></div>
      </section>

      <section id="tab-settings" class="bg-white rounded shadow p-4 hidden">
        <h2 class="font-medium mb-3">账号设置</h2>
        <form id="userForm" class="space-y-3">
          <div>
            <label class="block text-sm text-slate-600 mb-1">当前用户名</label>
            <div id="currentUsername" class="text-slate-800"></div>
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">新用户名（可选）</label>
            <input name="username" class="w-full border rounded px-3 py-2" autocomplete="username" placeholder="不修改则留空" />
          </div>
          <div>
            <label class="block text-sm text-slate-600 mb-1">旧密码</label>
            <input name="oldPassword" type="password" autocomplete="current-password" class="w-full border rounded px-3 py-2" required />
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="block text-sm text-slate-600 mb-1">新密码</label>
              <input name="password" type="password" autocomplete="new-password" class="w-full border rounded px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm text-slate-600 mb-1">确认新密码</label>
              <input name="password2" type="password" autocomplete="new-password" class="w-full border rounded px-3 py-2" />
            </div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-primary pressable">保存</button>
            <button type="reset" class="btn pressable">重置</button>
          </div>
        </form>

        <hr class="my-6" />

        <div class="space-y-3">
          <h3 class="font-medium">二步验证（TOTP）</h3>
          <div class="text-sm text-slate-600">使用认证器应用（如 Google Authenticator、1Password）生成登录验证码。</div>
          <div class="flex items-center gap-2">
            <div id="totpStatus" class="text-sm text-slate-700">读取中…</div>
            <button id="totpEnableBtn" class="btn pressable">开启</button>
            <button id="totpDisableBtn" class="btn pressable">关闭</button>
          </div>
        </div>

        <hr class="my-6" />

        <div class="space-y-3">
          <h3 class="font-medium">扫码登录</h3>
          <div class="text-sm text-slate-600">使用已登录设备扫描二维码以在新设备上登录。</div>
          <div class="flex items-center gap-2">
            <div id="qrLoginStatus" class="text-sm text-slate-700">读取中…</div>
            <button id="qrLoginEnableBtn" class="btn pressable">开启</button>
            <button id="qrLoginDisableBtn" class="btn pressable">关闭</button>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <button id="qrScanBtn" class="btn pressable">扫一扫授权新设备</button>
            <button id="qrScanFromFileBtn" class="btn pressable">从相册选择二维码</button>
          </div>
        </div>

        <hr class="my-6" />

        <div class="space-y-3">
          <h3 class="font-medium">通行密钥（WebAuthn）</h3>
          <div class="text-sm text-slate-600">在设备上使用生物识别或系统锁登录。</div>
          <div class="flex items-center gap-2">
            <button id="passkeyRegisterBtn" class="btn pressable">注册通行密钥</button>
          </div>
          <div id="passkeyList" class="divide-y"></div>
        </div>
      </section>

      <section id="tab-system" class="bg-white rounded shadow p-4 hidden">
        <h2 class="font-medium mb-3">系统设置</h2>
        <form id="systemForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-slate-600 mb-1">自动清理</label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" name="autoCleanupEnabled" class="mr-1"> 启用周期性清理</label>
              <p class="text-xs text-slate-500 mt-1">清理过期消息与文件；可与“消息保留天数”配合使用</p>
            </div>
            <div>
              <label class="block text-sm text-slate-600 mb-1">清理间隔（分钟）</label>
              <input type="number" name="cleanupIntervalMinutes" min="1" class="input" placeholder="720" />
            </div>
            <div>
              <label class="block text-sm text-slate-600 mb-1">消息保留天数</label>
              <input type="number" name="messageTtlDays" min="0" class="input" placeholder="90" />
              <p class="text-xs text-slate-500 mt-1">0 表示不自动删除；>0 时删除早于该天数的消息与文件</p>
            </div>
            <div>
              <label class="block text-sm text-slate-600 mb-1">JWT 过期天数（记住我）</label>
              <input type="number" name="jwtExpiresDays" min="0" class="input" placeholder="7" />
            </div>
            <div>
              <label class="block text-sm text-slate-600 mb-1">临时登录有效期（分钟）</label>
              <input type="number" name="tempLoginTtlMinutes" min="1" class="input" placeholder="10" />
            </div>
            <div>
              <label class="block text-sm text-slate-600 mb-1">移动端顶部栏自动隐藏</label>
              <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" name="headerAutoHide" class="mr-1"> 启用</label>
              <p class="text-xs text-slate-500 mt-1">顶部 50px 为唤起区域；10 秒无操作自动隐藏</p>
            </div>
          </div>
          <div>
            <button type="submit" class="btn btn-primary pressable">保存设置</button>
          </div>
        </form>
      </section>

      <section id="tab-devices" class="bg-white rounded shadow p-4 hidden">
        <h2 class="font-medium mb-3">设备管理</h2>
        <div id="deviceList" class="divide-y"></div>
      </section>

      <section id="tab-messages" class="bg-white rounded shadow p-4 hidden">
        <h2 class="font-medium mb-3">消息管理</h2>
        <div class="mb-3 flex items-center gap-2 flex-wrap">
          <input id="searchInput" class="flex-1 min-w-[220px] border rounded px-3 py-2" placeholder="搜索消息内容或文件名" />
          <select id="deviceFilter" class="border rounded px-3 py-2">
            <option value="">全部设备</option>
          </select>
          <button id="clearAllMessagesBtn" class="btn pressable text-rose-700 border-rose-300" title="清空全部消息与文件">清空全部</button>
        </div>
        <div id="messageListAdmin" class="space-y-2"></div>
      </section>

      <section id="tab-cache" class="bg-white rounded shadow p-4 hidden">
        <h2 class="font-medium mb-3">缓存管理</h2>
        <p class="text-sm text-slate-600 mb-3">清理本地静态资源缓存（HTML/CSS/JS）。不会清除登录状态、设备号或 Cookie。</p>
        <div class="flex items-center gap-2">
          <button id="clearCacheBtn" class="btn pressable">清除本地静态资源缓存</button>
        </div>
      </section>
    </main>
    <script src="/js/ui.js"></script>
    <script src="/js/templates.js"></script>
    <script src="/admin.js"></script>
    <script src="/js/theme.js"></script>
  </body>
  </html>
